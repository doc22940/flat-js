/**
 * Convenience wrapper for AJAX routines when using \flat\api PHP classes
 * 
 * author:     D. Bird
 * copyright:  Copyright (c) 2012-2017 Garrison Koch, Doug Bird, and Daniel Lepthien. All Rights Reserved.
 * 
 * @module flat/api
 */(function(){if(flat===null||typeof flat!="object"||typeof flat.load!="function")throw new Error("flat/api: missing flat-js");if(!jQuery)throw new Error("flat/api: missing jQuery");flat.load("api",function(){var e=3e4,t=flat.base_url,n=!0,r={};return r.api_base_url=t+"/api.php",r.get_url=function(e){if(flat.is_string(e))return r.api_base_url+"/"+e},r.cannot_get_path=function(e,t){var n={};t?t="reason: "+t:t="";if(!e)var e="";return n.url=e,n.toString=function(){return"could not get a path from given url"+t},n.name="cannot_get_path",n.message=n.toString,n},r.cannot_get_ref=function(e,t){var n={};t?t="reason: "+t:t="";if(!e)var e="";return n.url=e,n.toString=function(){return"could not get a path from given url"+t},n.name="cannot_get_ref",n.message=n.toString,n},r.props_arg_invalid=function(){var e={};return e.toString=function(){return"props arg is not object"},e.name="props_arg_invalid",e.message=e.toString,e},r.response_not_object=function(){var e={};return e.toString=function(){return"response is not object"},e.name="response_not_object",e.message=e.toString,e},r.missing_expected_property=function(e){if(typeof e=="string"||e instanceof String){var t={};return t.get_property=function(){return e},t.toString=function(){return"response missing property: "+e},t.name="missing_expected_property",t.message=t.toString,t}throw"property arg must be string"},r.url_to_path=function(e){var t;e||(e=flat.get_url());if(!e)throw r.cannot_get_path(e,"url arg not given and no environmental url");if((t=e.lastIndexOf(search="flat.php/"))<0&&(t=e.lastIndexOf(search="api.php/"))<0)throw r.cannot_get_path(e,"could not find flat sub path in url");return t+=search.length,e.substr(t)},r.url_to_ref=function(e,t){var n,s;e||(e=flat.get_url());if(!t){if(e.substr(-1)=="/"){n=e.split("/");for(i=n.length;i>=0;i<i--)if(n[i]){s=n[i];break}}else s=e.substr(e.lastIndexOf("/")+1);return s}if(!e.indexOf(t))throw r.cannot_get_ref(e,"missing path string that can be found in given url");return r.url_to_path(e).substr(t.length*-1)},r.is_valid_response=function(e,t){if(!flat.is_object(t))throw r.response_not_object;if(e.props)try{r.check_response_props(e.props,t)}catch(i){if(i==r.props_arg_invalid)throw i;if(i==r.missing_expected_property)return n&&log("response missing property: "+i.get_property()),!1;throw i}},r.check_response_props=function(e,t){if(!flat.is_array(e))throw r.props_arg_invalid;if(!flat.is_object(t))throw r.response_not_object;for(i=0;i<e.length;i++)if(!t[e[i]])throw r.missing_expected_property(e[i])},r.request=function(t,n,i){var s={path:"",url:"",type:"GET",data:"",callback:"",success:null,error:null,always:null,response_properties:"",send_JSON:!0},o=!1;if(arguments.length==1&&flat.is_object(t))for(var u in t)t.hasOwnProperty(u)&&s.hasOwnProperty(u)&&(o=!0,s[u]=t[u]);o||(s.path=t,flat.is_func(n)?s.callback=n:n&&(flat.is_func(n)?s.callback=n:(s.data=n,flat.is_func(i)&&(s.callback=i))));var a;s.callback&&flat.is_func(s.callback)&&(a=s.callback);var f="";s.url&&(f=s.url),f||(s.path?f=r.get_url(s.path):t&&(f=r.get_url(t)));if(!f)throw"cannot_determine_url";var l={url:f,type:s.type.toUpperCase(),timeout:e,async:!0};s.data&&(s.send_JSON&&l.type!="GET"?(l.data=JSON.stringify(s.data),l.contentType="application/json; charset=UTF-8"):l.data=s.data);var c=$.ajax(l);c.always(function(e,t){var n={};if(!flat.is_object(e))n=e,e={status:t},flat.is_string(n)&&(e.data=n);else if(e.responseJSON)e=e.responseJSON,e.data?n=e.data:n=e;else if(e.responseXML){var r=e.responseXML,i="https://github.com/katmore/flat/wiki/xmlns",o,u=r.getElementsByTagNameNS(i,"data");if(u.length){o=u[0];var f=o.getAttributeNS(i,"meta");if(f&&f=="flat\\error_collection"){var l=o.getElementsByTagNameNS(i+"-object","error");if(l&&l.length){var c=l[0].getElementsByTagNameNS(i,"data");if(c&&c.length){var h=["type","message","name","code"];for(var p=0;p<h.length;p++){var d=c[0].getElementsByTagNameNS(i+"-object",h[p]);d&&d.length&&d[0].childNodes&&d[0].childNodes.length&&(n[h[p]]=d[0].childNodes[0].nodeValue)}}}}}}else e.data?n=e.data:n=e;t=="success"?n&&e.checksum&&e.status&&e.status_code&&s.success&&flat.is_func(s.success)&&s.success(n,{status:e.status,code:e.status_code},e.checksum):s.error&&flat.is_func(s.error)&&(n&&n.message&&flat.is_string(n.message)?s.error(n.message,n,e):(console.log("WARNING: response is missing error message field"),s.error(t,n,e)));if(a||flat.is_func(s.always))a&&a(n,t,e),flat.is_func(s.always)&&s.always(n,t,e);else if(t!="success"){if(!s.error||!flat.is_func(s.error))throw n&&n.message?n.message:"request";return}})},r}())})();